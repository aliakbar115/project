# روش استفاده از سیستم Gravitee

------



## ایجاد یک api :

1. بعد از ورود به Developers Portal  بر روی `apis` کلید کرده و بر روی علامت `+` زده و بر روی دکمه `create` کلید می نمایید یک نام و یک توضیح برای  api مورد نظر تعیین می کنید و ورژن آن را وارد می کنید که به طور معمول ورژن 1 خواهد بود در قسمت ` Context path ` شما باید یک مسیر اضافه نمایید که برای دستیابی به  api مورد نظر استفاده می شود .  به طور مثال : post/  

   به این ترتیب برای دستیابی به api مورد نظر ، مشتری باید آدرس رو به رو را وارد کرد  https://api.tgju.org/am/posts

2. بر روی ` next ` کلید کرده و  وارد قسمت ` Gateway `  می شویم در این قسمت در بخش `Backend` ، آدرس api مورد نظر خود را وارد می کنیم به طور مثال https://jsonplaceholder.typicode.com/posts

3. بر روی `next` کلید کرده و  وارد قسمت `plan` می شویم در این قسمت می توانیم پلنی برای api بنویسیم این قسمت را فعلا `skip` می زنیم به این دلیل که در بخش دیگری می توان plan اضافه نمود 

4. دوباره بر روی `next` کلید می کنیم و وارد قسمت `doc` می شویم این قسمت را نیز فعلا `skip` می زنیم و وارد قسمت `Deployment` می شویم که اگر از صحت اطلاعات وارده مطمئن هستیم بر روی `create and start the api`  کلید می نماییم 

5. وارد api ساخته شده می شویم و در قسمت `Details` می توانیم عکسی برای api خود قرار دهیم همچنین می توانیم برای آن  label تعیین کنیم

6. در  پایین `Details`  و در قسمت `Danger Zone` بر روی `Start the API` و `Publish the API` و `Make Public` کلید می کنیم که این موارد سبب می شوند api ما در پنل مشتری نمایش داده شود توجه شود اگر بر روی `Make Public`  کلید نشود api فقط در زمان لاگین مشتری نمایش داده می شود .

   

   ------

   

## ایجاد plan برای api ساخته شده :

1. **تعیین ماه  :** وارد api مورد نظر می شویم و بر روی `plans` کلید می کنیم بر روی `+ `  کلید کرده و در قسمت `name` یک نام برای plan مورد نظر خود انتخاب می کنیم در سیستم فعلی به گونه ای بر نامه ریزی شده است که هر اسم شامل 3 بخش است به طور مثال` common_month_3 ` که عدد در این نام ، نشان دهنده مقدار ماهی است که اگر مشتری این plan را انتخاب نماید می تواند از api مورد نظر استفاده نماید و از این اسم در قسمت backend استفاده خواهد شد تا مقدار ماهه ، پلن انتخابی مشتری دریافت شود. توجه شود که فرمت نوشتن اسم حتما رعایت شود و عدد (نشان دهنده ماه) در قسمت سوم قرار گیرد و مقایدر با `_ ` از هم جدا شوند .

2. **تعیین قیمت :** در قسمت `Description` یک توضیح برای plan مورد نظر می نویسیم توجه شود از این قسمت هم ، قیمت plan انتخابی مشتری تعیین می شود شما می توانید در هر جای توضیح مورد نظر خود قیمت پلن را قرار دهید فقط فرمت تعیین قیمت حتما به شکل رو به رو تعیین شود چون در قسمت backend قیمت از عبارت رو به رو دریافت خواهد شد .  `قیمت: 28,000,000 ریال`   

3. بر روی next کلید می کنیم و وارد قسمت Secure می شویم از منو کشویی نوع Authentication را انتخاب می کنیم که ما در این پروژه از Api Key استفاده نموده ایم و آن را انتخاب می کنیم و بر روی next کلید می کنیم 

4. **Rate-Limit :** وارد بخش Restrictions می شویم از این بخش امکان انتخاب تعداد درخواست در هر دقیقه ، ماه و سال را داریم بر روی `Rate-Limit` کلید می کنیم . در هر دو بخش `(Max requests (static`  و `(Max requests (dynamic` عدد 2 را وارد کرده و در قسمت `Time unit` ، دقیقه را انتخاب می کنیم به این ترتیب امکان درخواست برای مشتری در هر دقیقه 2 عدد خواهد بود 

5. در نهایت بر روی save کلید می کنیم و بعد از ساخته شدن plan مورد نظر بر روی `publish plan (فلش بالا)` کلی می کنیم تا plan انتخابی publish شود .

6. همچینین شما می توانید بر روی `design Plan` کلید نمایید که از این طریق می توان فیلترهای مختلفی را بر روی plan خود قرار دهید که برای اطلاعات بیشتر می توانید این بخش را مطالعه بفرمایید https://docs.gravitee.io/apim/3.x/apim_policies_overview.html

7. هر api شامل 4 پلن خواهد بود که شامل یک ماه ، 3 ماه ، 6 ماه و 12 ماه خواهد بود و حتما بعد از تعیین همه plan ها بر روی `deploy your API` در بالای صفحه کلید نمایید .

8. **ip-filtering** : 

   این قسمت برای این است که یک ip خاص فقط بتواند از یک پلن استفاده کند یا یک ip خاص نتواند استفاده کند . برای فعال کردن این قسمت وارد یک api  می شویم و در پایین وارد قسمت design می شویم از روی سمت چپ روی پلن مورد نظر خود کلید می کنیم و از سمت راست **ip-filtering**  را پیدا می کنیم و آن را بر روی قسمت request  درگ می کنیم و در پایین دو قسمت لیست سیاه و لیست سفید دارد که می توانیم ip  های خود را در آن ها قرار دهیم . 

   

   ------

   



## ایجاد **Documentation** برای api :

#### 1- بخش pages :

* در این قسمت شما می توانید موارد مختلفی document  برای  api خود طراحی نماید و مشتری بتواند آن ها را مطالعه نماید و انتخاب خود را دقیق تر انجام دهد . در این پروژه ما از Markdown و swagger استفاده نمودیم در ادامه توضیحات نحوه اضافه نمودن فایل Markdown یا swagger توضیح داده خواهد شد.

- وارد این بخش می شویم و بر روی `+` کلید کرده و `MARKDOWN` را انتخاب می نماییم اگر `Set as homepage`   را تیک بزنیم در صفحه اول نمایش API برای مشتری این داکیومنت قرار می گیرد و همچینین باید روی ` Publish this page ` کلید نماییم و بعد داکیومنت خود را وارد می کنیم و بر روی SAVE کلید می کنیم به این ترتیب در صفحه اول نمایش API برای مشتری این توضیحات قرار می گیرد . 

- در DOC مورد نظر خود توضیحات API ، روش پرداخت مبلغ ، قیمت هر پلن و همچنین روش دسترسی بعد از پرداخت تعیین شود که نمونه آن از دیگر api ها قابل برداشت است .    

- همچینین شما می توانید یک فایل swagger را برای داکیومنت api وارد کنید که در این پروژه ما آن را در سربرگ دوم قرار می دهیم فایل swagger خود را نوشته و دقیقا مثل بالا گزینه ها را انتخاب می کنیم و save را می زنیم فقط بر روی  `Set as homepage`   کلید نمی کنیم  تا در صفحه بعدی قرار گیرد .

- در ایجاد فایل swagger  حتما صفحه بندی و هم تعداد موارد مشاهده در یک صفحه لحاظ شود این موارد باید با متغییر های page ,limit  قابل انتخاب می باشند .

- بعد از نوشتن فایل swagger و ذخیره کردن آن ، باید وارد سربرگ configuration از همان فایل swagger شوید و بر روی Enable Try it mode کلید نمایید تا قسمت try it  در فایل  swagger  فعال شود و مشتری بتواند در صورت داشتن api_key  ، اطلاعات دریافتی api را مشاهده نماید . 

- همچنین موارد Display vendor extensions , Display extensions بهتر است انتخاب شوند . 

- در تهیه فایل swagger از نسخه "openapi": "3.0.0" استفاده نمایید چون gravitee  با این نسخه هماهنگ تر می باشد .

- برای اینکه اطلاعات api علاوه بر swagger داخلی gravitee  در سایر فایل های swagger هم قابل دسترس باشد باید وارد api تعریفی خود شویم وارد قسمت proxy شویم CORS را انتخاب می کنیم در قسمت `Access-Control-Allow-Origin ` ستاره (*)  را قرار می دهیم و در قسمت `Access-Control-Allow-Headers`  عبارت `x-gravitee-api-key ` را قرار می دهیم همچنین در قسمت `Specifies the method`  عبارت get را انتخاب می کنیم .

  

#### 2- بخش metadata :

- شما می توانید metadata  برای api خود تعیین کنید و به طور مثال در بخش صفحه Markdown به این متغییر دسترسی داشته باشید . به طور مثال ما در این بخش یک metadata با نام Host تعریف نمودیم که از این متغییر برای تعریف آدرس backend و دسترسی به قسمت پرداخت استفاده نمودیم که در قسمت  markdown برای هر api قابل مشاهده است .

- در واقع metadata یک نوع تعریف متغییر می باشد و بهتر است برای اینکه متغییر ما در همه api ها قابل استفاده باشد وارد قسمت setting شویم و در بخش metadata  ، متغییر خود را تعریف نماییم که در همه api ها قابل دسترس باشد .

  

  ------

  

##  application :

1. برای استفاده از هر api یک مشتری ابتدا باید یک application داشته باشد و از طریق همان application به یکی از پلن های (1 و 3 و 6 و 12 ماهه ) api مورد نظر خود درخواست سابسکرایب دهد .  در ابتدا لازم است که هر مشتری یک application مخصوص به خود را داشته باشد و ما باید آن را برای هر مشتری ایجاد نماییم که ما در این پروژه این کار را از طریق api reference  انجام می دهیم . 
2. وقتی یک مشتری یکی از plan های api مورد نظر خود را انتخاب می کند و مبلغ آن را پرداخت می کند ما از طریق api refrence و در قسمت backend که با php  می باشد یک application  برای او می سازیم البته این مورد درحالتی است که اولین خرید وی باشد و قبلا با هیچ اپلیکیشنی سابسکرایب نکرده باشد که اگر قبلا خرید انجام داده باشد ما دیگر برای او application جدید نمی سازیم و از همان اپلیکیشن قدیمی استفاده می کنیم .
3. برای اینکه با روند ایجاد اپلیکیشن آشنا شویم در پایین و در پنل مدیریت اقدام به ایجاد یک application می کنیم البته همان طور که گفته شد ما بعدا برای هر مشتری این کار را با api reference  انجام می دهیم که آدرس api reference به شرح رو به رو می باشد .   https://docs.gravitee.io/apim/3.x/management-api/3.17/



## ایجاد application در پنل مدیریت : 

1. وارد قسمت `applications` می شویم بر روی `+` کلید کرده  یک نام و یک توضیح برای آن وارد می کنیم و روی `next` می زنیم در سربرگ Security در قسمت type ، عبارت web  را قرار می دهیم و می توانیم یک client_id  برای app خود قرار دهیم که البته این کار اجباری نیست چون client_id  برای روش oath یا jwt کاربرد دارد و چون ما از api_key استفاده می کنیم نیازی نیست .

2. در قسمت Subscriptions باید یک api را از لیست کشویی انتخاب کنیم که به محض انتخاب تمام پل های آن در پایین قرار می گیرد یک پنل را انتخاب می کنیم و بر روی  `request for subscription`    می زنیم تا app ما به یکی از پنل های انتخابی درخواست دهد و به عبارتی به آن متصل شود البته این کار حتما لازم نیست و می توانیم فقط اقدام به ایجاد app کنیم و به هیچ api فعلا متصل نشود .

3. در انتها بر روی `create the application` می زنیم تا app ما ایجاد شود . توجه شود چون این app در پنل مدیریت ایجاد شده است ایجاد کننده مدیر خواهد بود و برای مشتریان قابل دیدن نخواهد شد . و مشتریان به این app دسترسی ندارند .

   

------



##  Subscriptions :

برای اینکه یک مشتری بتواند از یک api استفاده کند در ابتدا باید یک application داشته باشد بعد باید از این app به یکی از پلن های api مورد نظر درخواست subscribe دهد و بعد از درخواست ، و accept آن توسط مدیریت به یک api_key دسترسی خواهد داشت که از آن می تواند برای دسترسی به api  استفاده نماید . باید توجه نمود که هم  subscribe و هم api_key دارای یک زمان انقضا هستند که بعد از آن تاریخ دیگر آن api ، از دسترس خارج می شود و ما از این موضوع برای یک ماهه ، 3 ماهه ، 6 ماهه و 12 ماهه استفاده می کنیم . برای درک بهتر این موضوع عملیات subscribe در پنل مدیریت توضیح داده می شود .



## عملیات subscribe در پنل مدیریت :

یک api  را انتخاب می کنیم  و وارد قسمت `Subscriptions` می شویم بر روی `+` کلید می کنیم یک app را انتخاب می کنیم و در پایین یکی از پنل های آن را انتخاب می کنیم بر روی create  کلید می کنیم به این ترتیب یک api_key دریافت می کنیم توجه شود به راحتی می توان زمان دسترسی به api_key را تغییر داد (با تغییر Expire at) 

نکته : به این موضوع باید توجه داشت بر اساس اینکه app انتخابی توسط چه شخصی ساخته شده است آن فرد در پنل خودش به این api_key ساخته شده دسترسی دارد و می تواند آن را در پنل مشتریان مشاهده کند .



------



## setting :

- ##### Categories : 

  در این قسمت می توانید دسته بندی برای api ها تعیین شود و بعد از اینکه یک دسته بندی ایجاد شد می توان لیستی از api ها را در این دسته بندی قرار داد . 

- ##### metadata : 

  در این قسمت می توانیم یک متغییر برای همه api ها تعریف کنیم که حسن تعریف در این قسمت این است که در همه api ها قابل دسترس خواهد بود

- ##### Theme :

  در این قسمت می توانیم رنگ و سایز ، دکمه ها و فونت ها و جدول ها را تغییر داد همچنین لوگو قرار داد .

- ##### Top APIs : 

  می توانیم لیستی از api های که می خواهیم در صفحه اول برای مشتری نمایش داده شود .





## Organization settings :

- ##### Templates :

  در این قسمت می توان متن نوتیفیکیشن های که بعد از هر عملیات نمایش داده می شود را تغییر داد 

- users :

  لیست کاربران و app ها و api های هر کاربر - همچنین امکان تغییر کاربر از یوزر عادی به ادمین وجود دارد

- roles :

  دسترسی های کاربران ادمین و یوزر عادی در این قسمت می تواند تغییر کند 

- ##### Settings

  تنظیمات تایتل پنل مدیریت ، CORS کلی و SMTP برای ارسال ایمیل در این قسمت قرار دارد که البته تنظیمات ایمیل از فایل gravitee.yml قابل تغییر است .



------



## APIM API reference : 

شما می توانید لیست همه رفرنس ها را در این لینک مشاهده نمایید .

https://docs.gravitee.io/apim/3.x/management-api/3.17





------



## روند کلی پیاده سازی شده :

1. در ابتدا یک مشتری یکی از api های تعریفی ما را در پنل خودش ( https://api.tgju.org ) را انتخاب می کند و وارد آن می شود که صفحه اطلاعات عمومی در مورد آن api را مشاهده می کند که شامل پنل های یک و 3 و شش و 12 ماهه و لینک های پرداخت هر کدام می باشد . هر لینک پرداخت به صورت زیر می باشد .

   https://white.webr.ir/pay/461f8cfd-ad0b-4465-9f8c-fdad0bf465e8/sana_month_1/user_id

2. که بعد از عبارت pay  ، آیدی api قرار دارد که در فایل markdown  با  عبارت {api.id}$  قابل دسترس می باشد  که به شکل زیر در فایل markdown ساخته شده است و در انتها هم آیدی یوزر کاربر می باشد .

   <a href='${api.metadata['host']}/pay/${api.id}/sana_month_1/user_id'>

   

3. بعد از کلید بر روی لینک پرداخت ، کاربر به backend هدایت می شود در آنجا بر اساس api انتخابی و پلنی که انتخاب شده است  مقدار ماه تعیین می شود به طور مثال عبارت sana_month_1 در لینک بالا ، نشان دهنده api سنا و پلن یک ماهه آن است پس ما ، month را یک در نظر می گیریم 

   

4. و بر اساس api_id  و ارسال درخواست به پنل مدیریت اطلاعات ان api دریافت می شود که شامل لیست پنل ها هم خواهد بود . در نهایت بر اساس توضیحات پنل انتخابی ( description )، قیمت جدا می شود . جدا سازی قیمت به این شکل است که هر جای توضیحات از فرمت رو به رو استفاده شود `قیمت: 28,000,000 ریال`  . قیمت از آن جدا می شود به طور مثال قیمت  `28000000` ذخیره خواهد شد .

5. قیمت , ماه  , api_id , plan_id , user_id در یک جدول ذخیره خواهد شد و کاربر به صفحه پرداخت هدایت خواهد شد .

6. بعد از پرداخت مبلغ توسط کاربر ، در صورتی که کاربر از قبل application نداشته باشد برای وی ساخته خواهد شد و اگر app داشته باشد از همان app استفاده می شود که ساخت app  توسط APIM API reference  انجام می شود . https://docs.gravitee.io/apim/3.x/management-api/3.17

7. چون app  ساخته شده توسط ادمین انجام شده است پس کاربر در پنل خودش به آن دسترسی نخواهد داشت به همین جهت کاربر را به این application  اضافه می کنیم که بر اساس آیدی کاربر این عمل قابل انجام است 

8. بعد از این بررسی می شود که آیا کاربر قبلا به این پلن از api در خواست سابسکرایب داده است یا نه . که اگر داده باشد که ما همان سابسکرایب را آبدیت می کنیم و api_key متعلق به مشتری نباید تغییری پیدا کند . اما اگر قبلا هیچ سابسکرایبی انجام نشده باشد ما یک سابسکرایب برای مشتری ایجاد می کنیم . روش کار به این ترتیب است که ما لیست سابسکرایب هایی که توسط application مشتری بر روی این api خاص انجام شده است را می گیریم که در واقع در این حالت باید یا خالی باشد یا یک مقدار درونش باشد . اگر مقداری بود آن سابسکرایب آبدیت می شود و اگر نبود یکی ساخته می شود.

9. باید توجه شود که هم سابسکرایب و هم api_key  قایل آبدیت شدن هستند و هر مشتری توسط اپلیکیشنی که برایش ساخته شده است فقط یک بار به یکی از پلن های آن api  درخواست سابسکرایب می دهد و در مواردی که پلن های دیگر آن api  را انتخاب نمود آن سابسکرایب و api_key مربوط به آن بر اساس ماه انتخابی مشتری آبدیت می شوند ( آبدیت  expire_at )

   به طور مثال یک مشتری پلن یک ماهه sana  را انتخاب می کند و بر اساس آن یک سابسکرایب برایش ساخته می شود و یک api_key  دریافت می کند بعد از آن که مثلا چند روز بعد پلن 3 ماهه همین sana  را انتخاب کرد مقدار 3 ماه به یک ماه سابسکرایب اضافه می شود و زمان سابسکرایب آبدیت می شود . 

10. 





















  



































































































































